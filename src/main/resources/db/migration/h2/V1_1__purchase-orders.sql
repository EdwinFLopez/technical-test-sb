CREATE TABLE IF NOT EXISTS PURCHASE_ORDERS (
    ORDER_ID VARCHAR(36) PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(255) NOT NULL,
    SHIPPING_ADDRESS VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS PURCHASE_ORDER_DETAILS (
    ORDER_ID VARCHAR(36) NOT NULL,
    BOOK_ID VARCHAR(36) NOT NULL,
    QUANTITY INT DEFAULT 1,

    CONSTRAINT PO_DETAILS_PKEY
    PRIMARY KEY (ORDER_ID, BOOK_ID),

    CONSTRAINT PO_DETAILS_BOOKS_FKEY
    FOREIGN KEY (BOOK_ID)
    REFERENCES BOOKS(ID),

    CONSTRAINT PO_DETAILS_ORDERS_FKEY
    FOREIGN KEY (ORDER_ID)
    REFERENCES PURCHASE_ORDERS(ORDER_ID)
);

-- Trick to use automatic interface-based data serialization in spring-data.
CREATE VIEW IF NOT EXISTS PURCHASE_ORDERS_WITH_DETAILS AS
SELECT PO.ORDER_ID as "orderId",
    PO.CUSTOMER_NAME as "customerName",
    PO.SHIPPING_ADDRESS as "shippingAddress",
    BK.ID AS "bookId",
    BK.NAME AS "bookName",
    PD.QUANTITY AS "quantity"
FROM PURCHASE_ORDERS PO
JOIN PURCHASE_ORDER_DETAILS PD ON PO.ORDER_ID = PD.ORDER_ID
LEFT JOIN BOOKS BK ON BK.ID = PD.BOOK_ID
ORDER BY PO.ORDER_ID, BK.NAME;

-- 1
INSERT INTO PURCHASE_ORDERS (ORDER_ID, CUSTOMER_NAME, SHIPPING_ADDRESS)
VALUES ('ae1666d6-6100-4ef0-9037-b45dd0d5bb0f', 'Houa Dina', 'Gerhild Street 50, Barcelona, Spain');

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6100-4ef0-9037-b45dd0d5bb0f', '22d580fc-d02e-4f70-9980-f9693c18f6e0', 2);

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6100-4ef0-9037-b45dd0d5bb0f', 'd02b58ae-8731-451c-9acb-1941adf88501', 1);

-- 2
INSERT INTO PURCHASE_ORDERS (ORDER_ID, CUSTOMER_NAME, SHIPPING_ADDRESS)
VALUES ('ae1666d6-6200-4ef0-9037-b45dd0d5bb0e', 'Gerhild Hayleigh', 'Mariya Street 94, Madrid, Spain');

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6200-4ef0-9037-b45dd0d5bb0e', '58716995-b335-4bb0-89c1-3503bc003118', 1);

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6200-4ef0-9037-b45dd0d5bb0e', 'e415e3af-e87e-47e6-9bf2-f08c72e2f281', 1);

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6200-4ef0-9037-b45dd0d5bb0e', '623d6650-5d98-457d-aacc-deba222f5cde', 1);

-- 3
INSERT INTO PURCHASE_ORDERS (ORDER_ID, CUSTOMER_NAME, SHIPPING_ADDRESS)
VALUES ('ae1666d6-6300-4ef0-9037-b45dd0d5bb0d', 'Polydeukes Virginia', 'Picasso Street 240, Bilbao, Spain');

INSERT INTO PURCHASE_ORDER_DETAILS (ORDER_ID, BOOK_ID, QUANTITY)
VALUES ('ae1666d6-6300-4ef0-9037-b45dd0d5bb0d', '22627251-75ea-441f-b58d-09d8b470f661', 1);

